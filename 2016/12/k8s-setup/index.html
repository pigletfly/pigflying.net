<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>kubernetes 1.5.1 搭建过程 — Just flying</title>
  
<meta name="google-site-verification" content="xuxKWekoKGP6azWZauNXZd_ubuylDqhbe11cvhK0a6g" />

<link rel="stylesheet" href="/css/yue.css">
<link rel="stylesheet" href="/css/font.css">
<link rel="stylesheet" href="/css/pygments.css">
<link rel="stylesheet" href="/css/site.css">


  
</head>
<body>
  <div id="header">
  <div class="container yue">
    <div id="brand"><a href="/">大海里的木鱼</a></div>
    <div id="nav" role="navigation">
      
        <a href="/about/">About</a>
      
        <a href="/archive/">Archive</a>
      
    </div>
  </div>
</div>

  <div id="main">
    <div class="container yue">
      <div class="hentry" itemscope itemtype="http://schema.org/Article">
        <h1 class="entry-title" itemprop="name">kubernetes 1.5.1 搭建过程</h1>
        
        <div class="entry-meta">
          <time class="updated" datetime="2016-12-20T09:34:00+08:00" itemprop="datePublished" pubdate>
            2016-12-20
          </time>
          <span class="author vcard">
            <a class="fn" itemprop="author" href="/">pigletfly</a>
          </span>
        </div>
        
        <div class="entry-content" itemprop="articleBody">
          <p>最近折腾了下 kubernetes 1.5.1,记录下安装过程。</p>

<ul>
  <li>安装相关依赖(master node 都需要操作)</li>
</ul>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo tee /etc/yum.repos.d/docker.repo <span class="sh">&lt;&lt;-'EOF'
[dockerrepo]
name=Docker Repository
baseurl=https://yum.dockerproject.org/repo/experimental/centos/7/
enabled=1
gpgcheck=1
gpgkey=https://yum.dockerproject.org/gpg
EOF

</span>yum install -y golang
yum install docker-engine -y
yum -y install ntp
yum install net-tools  bridge-utils <span class="nb">bind</span>-utils -y
yum install socat -y
yum install -y ebtables

systemctl <span class="nb">enable </span>ntpd
systemctl start ntpd
systemctl <span class="nb">enable </span>docker
systemctl start docker
systemctl status docker

setenforce 0
systemctl disable iptables-services firewalld
systemctl stop iptables-services firewalld


</code></pre>
</div>

<ul>
  <li>编译安装 rpm 包(master node 都需要操作)</li>
</ul>

<p>源代码 <a href="https://github.com/kubernetes/release">release</a>，进入 <code class="highlighter-rouge">/data/release/rpm</code>,修改 <code class="highlighter-rouge">kubelet.spec</code> 里的 <code class="highlighter-rouge">%global KUBE_VERSION 1.4.6</code>，修改为对应的版本，运行 <code class="highlighter-rouge">./docker-build.sh</code>，执行成功后 rpm 包在 output 目录下。
运行 <code class="highlighter-rouge">rpm -ivh *.rpm</code> 安装所有编译成功的 rpm 包。可以在一台机器上编译成功后拷贝到其他机器。</p>

<ul>
  <li>准备镜像</li>
</ul>

<p>由于墙的原因，从 Google 拉不了相关镜像，可以使用国内的灵雀云国际节点转一下，然后打 tag 。官方镜像地址，<a href="https://console.cloud.google.com/kubernetes/images/list?location=GLOBAL&amp;project=google-containers">google-containers</a>。如果不确定版本，在初始化 <code class="highlighter-rouge">master</code> 节点时，去查看 <code class="highlighter-rouge">/etc/kubernetes/manifests</code> 目录下相关文件。如果有私有仓库，可以打完标签后存储到私有仓库里。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nv">images</span><span class="o">=(</span>dnsmasq-metrics-amd64:1.0 kubedns-amd64:1.9 kube-scheduler-amd64:v1.5.1 kube-controller-manager-amd64:v1.5.1 kube-apiserver-amd64:v1.5.1 etcd-amd64:3.0.14-kubeadm kube-dnsmasq-amd64:1.4 exechealthz-amd64:1.2 pause-amd64:3.0 kubernetes-dashboard-amd64:v1.5.0 kube-discovery-amd64:1.0 kube-proxy-amd64:v1.5.1<span class="o">)</span>
<span class="k">for </span>imageName <span class="k">in</span> <span class="k">${</span><span class="nv">images</span><span class="p">[@]</span><span class="k">}</span> ; <span class="k">do
  </span>docker pull registry.alauda.cn/pigletfly/<span class="nv">$imageName</span>
  docker tag registry.alauda.cn/pigletfly/<span class="nv">$imageName</span> gcr.io/google_containers/<span class="nv">$imageName</span>
  docker rmi registry.alauda.cn/pigletfly/<span class="nv">$imageName</span>
<span class="k">done</span>

</code></pre>
</div>

<ul>
  <li>初始化 master</li>
</ul>

<p>首先进行重置，防止有环境残留。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>
systemctl stop kubelet;
<span class="c"># 注意: 下面这条命令会干掉所有正在运行的 docker 容器，# 如果要进行重置操作，最好先确定当前运行的所有容器都能干掉(干掉不影响业务)，# 否则的话最好手动删除 kubeadm 创建的相关容器(gcr.io 相关的)</span>
docker rm -f -v <span class="k">$(</span>docker ps -q<span class="k">)</span>;
find /var/lib/kubelet | xargs -n 1 findmnt -n -t tmpfs -o TARGET -T | uniq | xargs -r umount -v;
rm -rf /etc/kubernetes /var/lib/kubelet /var/lib/etcd;

</code></pre>
</div>

<p>然后启动 kubelet</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>systemctl <span class="nb">enable </span>kubelet
systemctl start kubelet
</code></pre>
</div>

<p>最后开始初始化</p>

<div class="highlighter-rouge"><pre class="highlight"><code>kubeadm init --api-advertise-addresses 172.30.215.19 --use-kubernetes-version v1.5.1 --pod-network-cidr=172.31.0.0/16
</code></pre>
</div>

<p>初始化成功后会打印 token</p>

<div class="highlighter-rouge"><pre class="highlight"><code>kubeadm join --token=6e57ff.1e0ee161fa4a3c4a 172.30.198.62
</code></pre>
</div>

<p>在 node 节点上运行上面的即可</p>

<ul>
  <li>验证</li>
</ul>

<p>加入节点后，可以验证下相关信息。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>netstat -atnp  |grep 443
kubectl get cs
kubectl cluster-info
kubectl get pod --namespace=kube-system
kubectl get po --namespace=kube-system -o wide
kubectl describe svc kubernetes-dashboard --namespace=kube-system
kubectl get svc --namespace=kube-system
</code></pre>
</div>

        </div>
      </div>
      
        <div class="entry-tags">
          
            <a class="tag" href="/archive/#kubernetes">kubernetes</a>
          
        </div>
      
      



    </div>
  </div>
  <script>
  function js(u){
    var d=document,a='script',s=document.createElement(a),f=d.getElementsByTagName(a)[0];s.src=u,s.async=true;f.parentNode.insertBefore(s,f);return s;
  }
  
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34929546-1']);
  _gaq.push(['_setDomainName', 'pigflying.net']);
  _gaq.push(['_trackPageview']);
  _gaq.push(['_trackPageLoadTime']);
  (function() {
    if (location.port) return;
    js('https://ssl.google-analytics.com/ga.js');
  })();
  
</script>
<div id="footer">
  <div class="container">
    <p>&copy; Copyright 2018 by pigletfly. Designed by <a href="http://lepture.com/" target="_blank">lepture</a></p>
  </div>
</div>

</body>
</html>
