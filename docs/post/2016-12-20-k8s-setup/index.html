<!DOCTYPE html>
<html lang="zh-hans">

<head>
    
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<meta name="HandheldFriendly" content="True" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta name="generator" content="Hugo 0.85.0" />






<title>kubernetes 1.5.1 搭建过程 - 大海里的木鱼</title>


<meta name="author" content="木鱼" />


<meta name="description" content="A minimal Hugo theme with nice theme color." />


<meta name="keywords" content="kubernetes" />


<meta property="og:title" content="kubernetes 1.5.1 搭建过程" />
<meta name="twitter:title" content="kubernetes 1.5.1 搭建过程" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.pigflying.net/post/2016-12-20-k8s-setup/" /><meta property="og:description" content="最近折腾了下 kubernetes 1.5.1,记录下安装过程。 安装相关依赖(master node 都需要操作) sudo tee /etc/yum.repos.d/docker.repo &lt;&lt;-&#39;EOF&#39; [dockerrepo] name=Docker Repository baseurl=https://yum.dockerproject.org/repo/experimental/centos/7/ enabled=1 gpgcheck=1 gpgkey=https://yum.dockerproject.org/gpg EOF yum install -y golang yum install docker-engine -y yum -y install ntp yum install net-tools bridge-utils bind-utils -y yum install socat -y yum install -y ebtables systemctl enable ntpd systemctl start ntpd systemctl enable docker systemctl start docker systemctl status docker setenforce 0 systemctl disable iptables-services firewalld" />
<meta name="twitter:description" content="最近折腾了下 kubernetes 1.5.1,记录下安装过程。 安装相关依赖(master node 都需要操作) sudo tee /etc/yum.repos.d/docker.repo &lt;&lt;-&#39;EOF&#39; [dockerrepo] name=Docker Repository baseurl=https://yum.dockerproject.org/repo/experimental/centos/7/ enabled=1 gpgcheck=1 gpgkey=https://yum.dockerproject.org/gpg EOF yum install -y golang yum install docker-engine -y yum -y install ntp yum install net-tools bridge-utils bind-utils -y yum install socat -y yum install -y ebtables systemctl enable ntpd systemctl start ntpd systemctl enable docker systemctl start docker systemctl status docker setenforce 0 systemctl disable iptables-services firewalld" /><meta property="og:image" content="https://www.pigflying.net/img/og.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://www.pigflying.net/img/og.png" /><meta property="article:published_time" content="2016-12-20T09:34:00+08:00" /><meta property="article:modified_time" content="2016-12-20T09:34:00+08:00" />


<style>
    @media (prefers-color-scheme: dark) {
        body[data-theme='auto'] img {
            filter: brightness(60%);
        }
    }

    body[data-theme='dark'] img {
        filter: brightness(60%);
    }
</style>




<link rel="stylesheet" href="https://www.pigflying.net/assets/css/fuji.min.css" />





<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-34929546-1');
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-34929546-1"></script>





</head>

<body
  >
    <script data-cfasync="false">
  
  var fujiThemeData = localStorage.getItem('fuji_data-theme');
  
  if (!fujiThemeData) {
    localStorage.setItem('fuji_data-theme', 'auto');
  } else {
    
    if (fujiThemeData !== 'auto') {
      document.body.setAttribute('data-theme', fujiThemeData === 'dark' ? 'dark' : 'light');
    }
  }
</script>

    

<div id="header">
    <div class="container yue">
      <div id="brand"><a href="https://www.pigflying.net">大海里的木鱼</a></div>
    </div>
    <div id="nav" role="navigation">
        
            <a href="/">Home</a>
        
            <a href="/archives/">Archives</a>
        
            <a href="/about/">About</a>
        
            <a href="/index.xml">RSS</a>
        
    </div>
</div>
  

    <div id="main">
        <div class="container yue">
            
            <div class="col-12 col-md-9 float-left content">
                
      <div class="hentry" itemscope itemtype="http://schema.org/Article">
        <h1 class="entry-title" itemprop="name">kubernetes 1.5.1 搭建过程</h1>
        <div class="entry-meta">
          
            <time class="updated" itemprop="datePublished" pubdate>
              2016-12-20
            </time>
          
          <span class="author vcard">
            <a class="fn" itemprop="author" href="/">木鱼</a>
          </span>
        </div>
        <div class="entry-content" itemprop="articleBody">
            <p>最近折腾了下 kubernetes 1.5.1,记录下安装过程。</p>
<ul>
<li>安装相关依赖(master node 都需要操作)</li>
</ul>
<pre><code class="language-bash">sudo tee /etc/yum.repos.d/docker.repo &lt;&lt;-'EOF'
[dockerrepo]
name=Docker Repository
baseurl=https://yum.dockerproject.org/repo/experimental/centos/7/
enabled=1
gpgcheck=1
gpgkey=https://yum.dockerproject.org/gpg
EOF

yum install -y golang
yum install docker-engine -y
yum -y install ntp
yum install net-tools  bridge-utils bind-utils -y
yum install socat -y
yum install -y ebtables

systemctl enable ntpd
systemctl start ntpd
systemctl enable docker
systemctl start docker
systemctl status docker

setenforce 0
systemctl disable iptables-services firewalld
systemctl stop iptables-services firewalld


</code></pre>
<ul>
<li>编译安装 rpm 包(master node 都需要操作)</li>
</ul>
<p>源代码 <a href="https://github.com/kubernetes/release" target="_blank">release</a>，进入 <code>/data/release/rpm</code>,修改 <code>kubelet.spec</code> 里的 <code>%global KUBE_VERSION 1.4.6</code>，修改为对应的版本，运行 <code>./docker-build.sh</code>，执行成功后 rpm 包在 output 目录下。
运行 <code>rpm -ivh *.rpm</code> 安装所有编译成功的 rpm 包。可以在一台机器上编译成功后拷贝到其他机器。</p>
<ul>
<li>准备镜像</li>
</ul>
<p>由于墙的原因，从 Google 拉不了相关镜像，可以使用国内的灵雀云国际节点转一下，然后打 tag 。官方镜像地址，<a href="https://console.cloud.google.com/kubernetes/images/list?location=GLOBAL&amp;project=google-containers" target="_blank">google-containers</a>。如果不确定版本，在初始化 <code>master</code> 节点时，去查看 <code>/etc/kubernetes/manifests</code> 目录下相关文件。如果有私有仓库，可以打完标签后存储到私有仓库里。</p>
<pre><code class="language-bash">images=(dnsmasq-metrics-amd64:1.0 kubedns-amd64:1.9 kube-scheduler-amd64:v1.5.1 kube-controller-manager-amd64:v1.5.1 kube-apiserver-amd64:v1.5.1 etcd-amd64:3.0.14-kubeadm kube-dnsmasq-amd64:1.4 exechealthz-amd64:1.2 pause-amd64:3.0 kubernetes-dashboard-amd64:v1.5.0 kube-discovery-amd64:1.0 kube-proxy-amd64:v1.5.1)
for imageName in ${images[@]} ; do
  docker pull registry.alauda.cn/pigletfly/$imageName
  docker tag registry.alauda.cn/pigletfly/$imageName gcr.io/google_containers/$imageName
  docker rmi registry.alauda.cn/pigletfly/$imageName
done

</code></pre>
<ul>
<li>初始化 master</li>
</ul>
<p>首先进行重置，防止有环境残留。</p>
<pre><code class="language-bash">
systemctl stop kubelet;
# 注意: 下面这条命令会干掉所有正在运行的 docker 容器，# 如果要进行重置操作，最好先确定当前运行的所有容器都能干掉(干掉不影响业务)，# 否则的话最好手动删除 kubeadm 创建的相关容器(gcr.io 相关的)
docker rm -f -v $(docker ps -q);
find /var/lib/kubelet | xargs -n 1 findmnt -n -t tmpfs -o TARGET -T | uniq | xargs -r umount -v;
rm -rf /etc/kubernetes /var/lib/kubelet /var/lib/etcd;

</code></pre>
<p>然后启动 kubelet</p>
<pre><code class="language-bash">systemctl enable kubelet
systemctl start kubelet
</code></pre>
<p>最后开始初始化</p>
<pre><code>kubeadm init --api-advertise-addresses 172.30.215.19 --use-kubernetes-version v1.5.1 --pod-network-cidr=172.31.0.0/16
</code></pre>
<p>初始化成功后会打印 token</p>
<pre><code>kubeadm join --token=6e57ff.1e0ee161fa4a3c4a 172.30.198.62
</code></pre>
<p>在 node 节点上运行上面的即可</p>
<ul>
<li>验证</li>
</ul>
<p>加入节点后，可以验证下相关信息。</p>
<pre><code>netstat -atnp  |grep 443
kubectl get cs
kubectl cluster-info
kubectl get pod --namespace=kube-system
kubectl get po --namespace=kube-system -o wide
kubectl describe svc kubernetes-dashboard --namespace=kube-system
kubectl get svc --namespace=kube-system
</code></pre>

        </div>
      </div>


<div class="license markdown-body">
    <blockquote>
        <p>除特殊注明部分，本站内容采用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"
               target="_blank">CC BY-NC-SA 4.0</a> 进行许可。</p>
    </blockquote>
</div>



            </div>
            
        </div>
        <div class="btn">
    <div class="btn-menu" id="btn-menu">
        <i class="iconfont icon-grid-sharp"></i>
    </div>
    <div class="btn-toggle-mode">
        <i class="iconfont icon-contrast-sharp"></i>
    </div>
    <div class="btn-scroll-top">
        <i class="iconfont icon-chevron-up-circle-sharp"></i>
    </div>
</div>
<aside class="sidebar-mobile" style="display: none;">
  <div class="sidebar-wrapper">
    
    <div class="sidebar-item sidebar-pages">
        <h3>页面</h3>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/archives/">Archives</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/index.xml">RSS</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>链接</h3>
        <ul>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>标签</h3>
        <div>
            
            <span>
                <a href="/tags/blogger/">Blogger</a>
            </span>
            
            <span>
                <a href="/tags/google/">Google</a>
            </span>
            
            <span>
                <a href="/tags/kubernetes/">kubernetes</a>
            </span>
            
            <span>
                <a href="/tags/other/">other</a>
            </span>
            
            <span>
                <a href="/tags/python/">python</a>
            </span>
            
            <span>
                <a href="/tags/tools/">tools</a>
            </span>
            
            <span>
                <a href="/tags/%E9%9A%8F%E7%AC%94/">随笔</a>
            </span>
            
        </div>
    </div>
    
    
    
    <div class="sidebar-item sidebar-toc">
        <h3>目录</h3>
        <nav id="TableOfContents"></nav>
    </div>
    
    
  </div>
</aside>

    </div>

    <div id="footer">
    <div class="container">
      <p>&copy; Copyright 2009-2021 by 木鱼. Designed by <a href="http://lepture.com/" target="_blank">lepture</a></p>
    </div>
</div>

    




<script defer src="/assets/js/fuji.min.js"></script>



</body>

</html>
